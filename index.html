<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CalTrack Mini</title>
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root { --pad:14px; --radius:14px; --fg:#111; --muted:#666; --line:#e8e8e8; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff;color:var(--fg)}
    header{position:sticky;top:0;background:#fff;padding:var(--pad);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;z-index:10}
    h1{font-size:18px;margin:0} .grow{flex:1}
    main{padding:var(--pad);padding-bottom:88px;max-width:820px;margin:0 auto}
    .card{border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{font-size:16px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.ghost{background:#f7f7f7}
    button.danger{background:#fff;border-color:#e33;color:#e33}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tfoot th{font-weight:700}
    .fab{position:fixed;right:16px;bottom:16px;display:flex;gap:10px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px}
    .hide{display:none}
    #chartWrap{min-height:260px;display:block}
    canvas{max-width:100%}
    .space{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>CalTrack Mini</h1>
    <div class="grow"></div>
    <button id="btnInstall" class="ghost">Install</button>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div>
          <div class="muted">วันที่</div>
          <div id="todayStr" style="font-weight:600"></div>
        </div>
        <div class="grow"></div>
        <div>
          <div class="muted">เป้าหมาย (kcal/วัน)</div>
          <div class="row">
            <input id="goal" type="number" inputmode="numeric" style="width:130px" placeholder="เช่น 1800">
            <button id="saveGoal" class="primary">บันทึก</button>
          </div>
        </div>
      </div>
      <p id="todaySummary" class="muted" style="margin:10px 0 0"></p>
    </section>

    <!-- เพิ่มเมนูโปรดใหม่ -->
    <section class="card">
      <h3 style="margin:0 0 8px">เพิ่มเมนูโปรด</h3>
      <div class="row">
        <input id="foodName" placeholder="ชื่ออาหาร เช่น อกไก่ปั่น" style="flex:1">
      </div>
      <div class="row">
        <select id="unit" style="flex:1;min-width:140px">
          <option value="g">หน่วยเป็นกรัม</option>
          <option value="serving">หน่วยเป็นเสิร์ฟ/ขวด</option>
        </select>
        <input id="kcalPerUnit" type="number" inputmode="decimal" placeholder="kcal ต่อ 1 หน่วยฐาน" style="flex:1;min-width:150px">
        <input id="baseAmount" type="number" inputmode="decimal" placeholder="หน่วยฐาน (เช่น 50 หรือ 100 หรือ 1)" style="flex:1;min-width:180px">
      </div>
      <div class="row">
        <input id="quickAmts" placeholder="Quick amounts คั่นด้วย , เช่น 50,100,150" style="flex:1">
        <button id="addFood" class="primary">เพิ่มเมนู</button>
      </div>
      <p class="muted" style="margin-top:6px">
        สูตรคำนวณ: <code>kcal = (จำนวนที่กิน / หน่วยฐาน) × kcalต่อหน่วยฐาน</code>
      </p>
    </section>

    <!-- รายการโปรดเป็น Dropdown + Quick amounts -->
    <section class="card">
      <h3 style="margin:0 0 8px">รายการโปรด (เลือกจาก Dropdown แล้วกดจำนวน)</h3>
      <div class="row">
        <select id="favSelect" style="flex:2"></select>
        <button id="deleteFav" class="danger">ลบเมนูนี้</button>
      </div>
      <div class="row" id="favQuickRow" style="margin-top:8px"></div>
    </section>

    <!-- บันทึกแบบกรอกเอง (Manual) -->
    <section class="card">
      <h3 style="margin:0 0 8px">บันทึกแบบกรอกเอง (Manual)</h3>
      <div class="row">
        <input id="manualName" list="nameSuggestions" placeholder="ชื่อเมนู เช่น อกไก่, ไก่ปั่น" style="flex:2">
        <datalist id="nameSuggestions"></datalist>
        <input id="manualKcal" type="number" inputmode="decimal" placeholder="kcal ทั้งเมนู" style="flex:1;min-width:140px">
        <button id="addManual" class="primary">บันทึก</button>
      </div>
      <p class="muted" style="margin-top:6px">เหมาะกับเมนูที่ไม่ได้อยู่ในรายการโปรด พิมพ์ชื่อ + ใส่ kcal แล้วกดบันทึก</p>
    </section>

    <!-- ตารางวันนี้ -->
    <section class="card">
      <h3 style="margin:0 0 8px">บันทึกวันนี้</h3>
      <table>
        <thead><tr><th>เวลา</th><th>เมนู</th><th>จำนวน</th><th>kcal</th><th></th></tr></thead>
        <tbody id="entriesTbody"></tbody>
        <tfoot><tr><th colspan="3">รวมวันนี้</th><th id="sumToday">0</th><th></th></tr></tfoot>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="clearToday" class="ghost">ลบรายการ “วันนี้”</button>
      </div>
    </section>

    <!-- กราฟ -->
    <section class="card">
      <h3 style="margin:0 0 8px">กราฟแคลอรี่รายวัน (ย้อนหลัง 30 วัน)</h3>
      <div class="row" style="margin-bottom:6px">
        <span class="muted">แตะ/กรอกเพื่อจด → กราฟอัปเดตทันที</span>
        <div class="space"></div>
        <button id="btnPrev" class="ghost">ย้อนอีก 30 วัน</button>
        <button id="btnNow" class="ghost">กลับมาวันนี้</button>
      </div>
      <div id="chartWrap">
        <canvas id="dailyChart" height="220" aria-label="กราฟแคลอรี่ต่อวัน"></canvas>
      </div>
    </section>
  </main>

  <div class="fab">
    <span class="chip">เมนูโปรด ➜ เลือกดรอปดาวน์ / Manual ➜ พิมพ์ชื่อ+kcal</span>
  </div>

<script defer>
  // ─── Storage Keys ────────────────────────────────────────────
  const LS = { foods:'ctm_foods', entries:'ctm_entries', settings:'ctm_settings', names:'ctm_manual_names' };

  // ─── Utils ───────────────────────────────────────────────────
  const $ = s => document.querySelector(s);
  const toISO = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const todayISO = toISO(new Date());
  $('#todayStr').textContent = todayISO;

  const load = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? f; }catch{ return f; } }
  const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  // ─── Data (preset เริ่มต้นตามที่คุย) ───────────────────────
  let foods = load(LS.foods, [
  {
    "id": "chicken_breast",
    "name": "อกไก่",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 165,
    "quick_amounts": [
      100,
      150,
      200,
      250
    ]
  },
  {
    "id": "chicken_shake",
    "name": "อกไก่ปั่น",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 300,
    "quick_amounts": [
      1
    ]
  },
  {
    "id": "egg",
    "name": "ไข่ไก่",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 70,
    "quick_amounts": [
      1,
      2,
      3,
      4
    ]
  },
  {
    "id": "egg_white",
    "name": "ไข่ขาว (เฉพาะขาว)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 17,
    "quick_amounts": [
      2,
      4,
      6,
      8
    ]
  },
  {
    "id": "tuna_water",
    "name": "ทูน่ากระป๋องในน้ำ",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 120,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "salmon",
    "name": "แซลมอน",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 208,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "tilapia",
    "name": "ปลานิล",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 128,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "mackerel",
    "name": "ปลาทู (นึ่ง/ย่าง)",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 205,
    "quick_amounts": [
      80,
      100,
      150
    ]
  },
  {
    "id": "seabass",
    "name": "ปลากะพงขาว",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 124,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "tofu_firm",
    "name": "เต้าหู้แข็ง",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 76,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "tofu_egg",
    "name": "เต้าหู้ไข่",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 90,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "tempeh",
    "name": "เทมเป้",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 193,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "natto",
    "name": "นัตโตะ",
    "unit": "g",
    "base_amount": 50,
    "kcal_per_unit": 100,
    "quick_amounts": [
      50,
      100,
      150
    ]
  },
  {
    "id": "greek_yogurt",
    "name": "โยเกิร์ตกรีก",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 140,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "skim_milk",
    "name": "นมจืดไขมัน 0%",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 90,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "whey",
    "name": "เวย์โปรตีน (1 scoop)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 120,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "cottage_cheese",
    "name": "คอทเทจชีส",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 98,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "shrimp",
    "name": "กุ้งต้ม",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 99,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "lean_pork",
    "name": "สันในหมู (ไม่ติดมัน)",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 143,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "lean_beef",
    "name": "เนื้อวัวไม่ติดมัน",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 187,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "jasmine_rice",
    "name": "ข้าวหอมมะลิสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 130,
    "quick_amounts": [
      100,
      150,
      200,
      250
    ]
  },
  {
    "id": "brown_rice",
    "name": "ข้าวกล้องสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 111,
    "quick_amounts": [
      100,
      150,
      200,
      250
    ]
  },
  {
    "id": "riceberry",
    "name": "ข้าวไรซ์เบอร์รี่สุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 120,
    "quick_amounts": [
      100,
      150,
      200,
      250
    ]
  },
  {
    "id": "sticky_rice",
    "name": "ข้าวเหนียวสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 168,
    "quick_amounts": [
      50,
      100,
      150
    ]
  },
  {
    "id": "oats",
    "name": "ข้าวโอ๊ตดิบ",
    "unit": "g",
    "base_amount": 50,
    "kcal_per_unit": 190,
    "quick_amounts": [
      30,
      40,
      50,
      60
    ]
  },
  {
    "id": "sweet_potato",
    "name": "มันหวาน",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 90,
    "quick_amounts": [
      100,
      200,
      300
    ]
  },
  {
    "id": "potato",
    "name": "มันฝรั่ง",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 77,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "pumpkin",
    "name": "ฟักทอง",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 26,
    "quick_amounts": [
      100,
      200,
      300
    ]
  },
  {
    "id": "bananas",
    "name": "กล้วยหอม",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 105,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "apple",
    "name": "แอปเปิล",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 95,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "orange",
    "name": "ส้ม",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 62,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "watermelon",
    "name": "แตงโม",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 30,
    "quick_amounts": [
      100,
      200,
      300
    ]
  },
  {
    "id": "wholewheat_bread",
    "name": "ขนมปังโฮลวีต",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 120,
    "quick_amounts": [
      1,
      2,
      3
    ]
  },
  {
    "id": "rice_noodles",
    "name": "เส้นหมี่ข้าวกล้องสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 109,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "glass_noodles",
    "name": "วุ้นเส้นสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 70,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "konjac",
    "name": "เส้นบุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 10,
    "quick_amounts": [
      100,
      200,
      300
    ]
  },
  {
    "id": "corn",
    "name": "ข้าวโพดต้ม",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 96,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "quinoa",
    "name": "ควินัวสุก",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 120,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "broccoli",
    "name": "บรอกโคลี",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 34,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "spinach",
    "name": "ผักโขม",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 23,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "cabbage",
    "name": "กะหล่ำปลี",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 25,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "lettuce",
    "name": "ผักกาดหอม",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 15,
    "quick_amounts": [
      50,
      100,
      150
    ]
  },
  {
    "id": "cucumber",
    "name": "แตงกวา",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 16,
    "quick_amounts": [
      100,
      200,
      300
    ]
  },
  {
    "id": "carrot",
    "name": "แครอท",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 41,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "mushroom",
    "name": "เห็ดนางฟ้า/เห็ดฟาง",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 22,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "tomato",
    "name": "มะเขือเทศ",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 18,
    "quick_amounts": [
      100,
      150,
      200
    ]
  },
  {
    "id": "olive_oil",
    "name": "น้ำมันมะกอก (1 ช้อนโต๊ะ)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 120,
    "quick_amounts": [
      0.5,
      1,
      1.5
    ]
  },
  {
    "id": "almonds",
    "name": "อัลมอนด์",
    "unit": "g",
    "base_amount": 30,
    "kcal_per_unit": 173,
    "quick_amounts": [
      15,
      30,
      45
    ]
  },
  {
    "id": "cashews",
    "name": "เม็ดมะม่วงหิมพานต์",
    "unit": "g",
    "base_amount": 30,
    "kcal_per_unit": 165,
    "quick_amounts": [
      15,
      30,
      45
    ]
  },
  {
    "id": "peanuts",
    "name": "ถั่วลิสงคั่ว",
    "unit": "g",
    "base_amount": 30,
    "kcal_per_unit": 170,
    "quick_amounts": [
      15,
      30,
      45
    ]
  },
  {
    "id": "avocado",
    "name": "อะโวคาโด",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 240,
    "quick_amounts": [
      0.5,
      1
    ]
  },
  {
    "id": "peanut_butter",
    "name": "เนยถั่ว (1 ช้อนโต๊ะ)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 95,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "pad_kra_pao_chicken_lean",
    "name": "ผัดกะเพราอกไก่ (น้ำมันน้อย)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 350,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "tom_yum_shrimp_clear",
    "name": "ต้มยำกุ้งน้ำใส",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 150,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "larb_chicken",
    "name": "ลาบไก่ (ไม่ใส่หนัง)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 200,
    "quick_amounts": [
      1,
      2
    ]
  },
  {
    "id": "grilled_chicken_thigh_skinless",
    "name": "ไก่ย่าง (เลาะหนัง)",
    "unit": "g",
    "base_amount": 100,
    "kcal_per_unit": 165,
    "quick_amounts": [
      80,
      100,
      150
    ]
  },
  {
    "id": "boiled_chicken_rice_light",
    "name": "ข้าวหน้าอกไก่ต้ม (ข้าวกล้อง 150g)",
    "unit": "serving",
    "base_amount": 1,
    "kcal_per_unit": 430,
    "quick_amounts": [
      1
    ]
  }
]);
  let entries = load(LS.entries, []);
  let settings = load(LS.settings, { daily_goal_kcal: 1800 });
  let manualNames = load(LS.names, []); // ชื่อที่เคยกรอกเอง

  const kcalOf = (food, amount)=> (amount / food.base_amount) * food.kcal_per_unit;

  // ─── Suggestions (datalist): foods + manualNames ────────────
  function renderNameSuggestions(){
    const dl = $('#nameSuggestions'); dl.innerHTML = '';
    const uniq = new Set([...foods.map(f=>f.name), ...manualNames]);
    [...uniq].sort().forEach(n=>{
      const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt);
    });
  }

  // ─── Favorites dropdown + quick amounts + delete ────────────
  function renderFavDropdown(){
    const sel = $('#favSelect'); sel.innerHTML = '';
    foods.forEach(f=>{
      const opt = document.createElement('option'); opt.value=f.id; opt.textContent=f.name; sel.appendChild(opt);
    });
    updateFavQuickRow();
  }
  function selectedFood(){
    const id = $('#favSelect').value;
    return foods.find(f=>f.id===id);
  }
  function updateFavQuickRow(){
    const row = $('#favQuickRow'); row.innerHTML = '';
    const f = selectedFood(); if(!f) return;
    (f.quick_amounts||[]).forEach(q=>{
      const btn = document.createElement('button');
      btn.textContent = `${q}${f.unit==='g'?'g':''}`;
      btn.onclick = ()=> addEntryByFood(f.id, q);
      row.appendChild(btn);
    });
  }
  $('#deleteFav').onclick = ()=>{
    const f = selectedFood(); if(!f) return;
    if(confirm(`ลบ "${f.name}" ออกจากรายการโปรด?`)){
      foods = foods.filter(x=>x.id!==f.id);
      save(LS.foods, foods);
      renderFavDropdown(); // refresh dropdown + quick
    }
  };
  $('#favSelect').onchange = updateFavQuickRow;

  // ─── Add new favorite ───────────────────────────────────────
  function addFood(){
    const name = $('#foodName').value.trim();
    const unit = $('#unit').value;
    const kcal_per_unit = Number($('#kcalPerUnit').value);
    const base_amount = Number($('#baseAmount').value);
    const quickAmts = $('#quickAmts').value.trim().split(',')
      .map(s=>Number(s.trim())).filter(n=>!isNaN(n)&&n>0);
    if(!name || !kcal_per_unit || !base_amount){ alert('กรอกชื่ออาหาร, kcal ต่อหน่วยฐาน, หน่วยฐาน ให้ครบ'); return; }
    const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Math.random().toString(36).slice(2,6);
    foods.push({id,name,unit,kcal_per_unit,base_amount,quick_amounts:quickAmts});
    save(LS.foods, foods);
    $('#foodName').value=''; $('#kcalPerUnit').value=''; $('#baseAmount').value=''; $('#quickAmts').value='';
    renderFavDropdown(); renderNameSuggestions();
  }
  $('#addFood').onclick = addFood;

  // ─── Manual add ─────────────────────────────────────────────
  function addManual(){
    const name = $('#manualName').value.trim();
    const kcal = Number($('#manualKcal').value);
    if(!name || !kcal || kcal<=0){ alert('กรอกชื่อเมนูและ kcal ให้ถูกต้อง'); return; }
    // เก็บชื่อไว้ใช้เป็น suggestion ครั้งต่อไป
    if(!manualNames.includes(name)){ manualNames.push(name); save(LS.names, manualNames); renderNameSuggestions(); }
    const entry = { _id: crypto.randomUUID(), date: todayISO, created_at:new Date().toISOString(),
      manual_name: name, amount: '', kcal: Math.round(kcal) };
    entries.push(entry); save(LS.entries, entries);
    $('#manualName').value=''; $('#manualKcal').value='';
    renderEntries(); updateChart();
  }
  $('#addManual').onclick = addManual;

  // ─── Goal & Summary ─────────────────────────────────────────
  const sumDayKcal  = iso => entries.filter(e=>e.date===iso).reduce((a,e)=>a+e.kcal,0);
  const sumTodayKcal= ()=> sumDayKcal(todayISO);

  function updateTodaySummary(){
    const sum = sumTodayKcal();
    const goal = Number(settings.daily_goal_kcal||0);
    let text = `วันนี้รวม ${sum.toFixed(0)} kcal`;
    if(goal>0){
      const remain = goal - sum;
      text += ` • เป้า ${goal} • เหลือ ${Math.max(remain,0).toFixed(0)} kcal`;
    }
    $('#todaySummary').textContent = text;
    $('#sumToday').textContent = sum.toFixed(0);
  }
  function renderGoal(){ $('#goal').value = settings.daily_goal_kcal ?? ''; updateTodaySummary(); }
  $('#saveGoal').onclick = ()=>{ const v=Number($('#goal').value); if(!v||v<=0) return alert('ระบุเป้าหมายให้ถูกต้อง');
    settings.daily_goal_kcal=v; save(LS.settings, settings); updateTodaySummary(); updateChart(); };

  // ─── Entries Table ──────────────────────────────────────────
  function renderEntries(){
    const tb = $('#entriesTbody'); tb.innerHTML = '';
    entries.filter(e=>e.date===todayISO).sort((a,b)=>a.created_at.localeCompare(b.created_at)).forEach(e=>{
      // ชื่อเมนู: จาก food_id หรือ manual_name
      let name = e.manual_name || '';
      let unitTxt = '';
      if(e.food_id){
        const f = foods.find(x=>x.id===e.food_id);
        name = f?f.name:'(เมนูถูกลบ)';
        unitTxt = f?(f.unit==='g'?'g':'เสิร์ฟ'):'';
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(e.created_at).toLocaleTimeString()}</td>
        <td>${name}</td>
        <td>${e.amount? e.amount + ' ' + unitTxt : '-'}</td>
        <td>${e.kcal.toFixed(0)}</td>
        <td><button class="ghost" data-id="${e._id}">ลบ</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-id]').forEach(b=>{
      b.onclick = ()=>{
        entries = entries.filter(x=>x._id !== b.dataset.id);
        save(LS.entries, entries); renderEntries(); updateTodaySummary(); updateChart();
      };
    });
    updateTodaySummary();
  }

  // ─── Add entry from favorite ─────────────────────────────────
  function addEntryByFood(food_id, amount){
    const f = foods.find(x=>x.id===food_id); if(!f) return;
    const entry = { _id: crypto.randomUUID(), date: todayISO, created_at:new Date().toISOString(),
      food_id, amount, kcal: Math.round(kcalOf(f, amount)) };
    entries.push(entry); save(LS.entries, entries);
    renderEntries(); updateChart();
  }

  // ─── Clear today ────────────────────────────────────────────
  $('#clearToday').onclick = ()=>{
    if(confirm('ลบรายการของวันนี้ทั้งหมด?')){
      entries = entries.filter(e=>e.date!==todayISO); save(LS.entries, entries);
      renderEntries(); updateChart();
    }
  };

  // ─── Chart (30-day rolling) ─────────────────────────────────
  let chart, startOffset = 0;
  const makeRange = (offset30=0)=>{
    const days=30, labels=[], data=[], goalLine=[];
    const goal = Number(settings.daily_goal_kcal||0);
    const end = new Date(); end.setDate(end.getDate()-offset30*days);
    const start = new Date(end); start.setDate(start.getDate()-(days-1));
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const iso=toISO(d); labels.push(iso); data.push(Math.round(sumDayKcal(iso))); goalLine.push(goal||null);
    }
    return {labels,data,goalLine};
  };
  function buildChart(){
    const ctx = document.getElementById('dailyChart');
    const {labels,data,goalLine} = makeRange(startOffset);
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[
        { label:'kcal/วัน', data, tension:0.25, pointRadius:3 },
        { label:'เป้าหมาย', data:goalLine, borderDash:[6,6], pointRadius:0 }
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:true}, tooltip:{callbacks:{label:(c)=>`${c.dataset.label}: ${c.parsed.y??0} kcal`}} },
        scales:{ x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:8}}, y:{beginAtZero:true,ticks:{stepSize:200}} }
      }
    });
  }
  function updateChart(){
    if(!window.Chart){ return; }
    if(!chart){ buildChart(); return; }
    const {labels,data,goalLine} = makeRange(startOffset);
    chart.data.labels=labels; chart.data.datasets[0].data=data; chart.data.datasets[1].data=goalLine; chart.update();
  }
  $('#btnPrev').onclick = ()=>{ startOffset+=1; updateChart(); };
  $('#btnNow').onclick  = ()=>{ startOffset=0;  updateChart(); };

  // ─── Init ───────────────────────────────────────────────────
  renderFavDropdown(); renderNameSuggestions();
  renderEntries(); renderGoal();
  if(window.Chart){ buildChart(); } else { window.addEventListener('load', ()=>{ if(window.Chart) buildChart(); }); }

  // ─── PWA SW & Install ───────────────────────────────────────
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
  let deferredPrompt=null; const btnInstall=document.getElementById('btnInstall');
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.classList.remove('hide'); });
  btnInstall.onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; deferredPrompt=null; if(outcome!=='dismissed'){ btnInstall.classList.add('hide'); } };
</script>
</body>
</html>
