<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CalTrack Mini</title>
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root { --pad:14px; --radius:14px; --fg:#111; --muted:#666; --line:#e8e8e8; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff;color:var(--fg)}
    header{position:sticky;top:0;background:#fff;padding:var(--pad);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;z-index:10}
    h1{font-size:18px;margin:0} .grow{flex:1}
    main{padding:var(--pad);padding-bottom:88px;max-width:820px;margin:0 auto}
    .card{border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{font-size:16px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.ghost{background:#f7f7f7}
    button.danger{background:#fff;border-color:#e33;color:#e33}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tfoot th{font-weight:700}
    .fab{position:fixed;right:16px;bottom:16px;display:flex;gap:10px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px}
    .hide{display:none}
    #chartWrap{min-height:260px;display:block}
    canvas{max-width:100%}
    .space{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>CalTrack Mini</h1>
    <div class="grow"></div>
    <button id="btnInstall" class="ghost">Install</button>
  </header>

  <main>
    <!-- ส่วนหัว + เป้าหมาย -->
    <section class="card">
      <div class="row">
        <div>
          <div class="muted">วันที่</div>
          <div id="todayStr" style="font-weight:600"></div>
        </div>
        <div class="grow"></div>
        <div>
          <div class="muted">เป้าหมาย (kcal/วัน)</div>
          <div class="row">
            <input id="goal" type="number" inputmode="numeric" style="width:130px" placeholder="เช่น 1800">
            <button id="saveGoal" class="primary">บันทึก</button>
          </div>
        </div>
      </div>
      <p id="todaySummary" class="muted" style="margin:10px 0 0"></p>
    </section>

    <!-- เพิ่มเมนูโปรด -->
    <section class="card">
      <h3 style="margin:0 0 8px">เพิ่มเมนูโปรด</h3>
      <div class="row">
        <input id="foodName" list="nameSuggestions" placeholder="ชื่ออาหาร เช่น อกไก่ปั่น" style="flex:1">
      </div>
      <div class="row">
        <select id="unit" style="flex:1;min-width:140px">
          <option value="g">หน่วยเป็นกรัม</option>
          <option value="serving">หน่วยเป็นเสิร์ฟ/ขวด</option>
        </select>
        <input id="kcalPerUnit" type="number" inputmode="decimal" placeholder="kcal ต่อ 1 หน่วยฐาน" style="flex:1;min-width:150px">
        <input id="baseAmount" type="number" inputmode="decimal" placeholder="หน่วยฐาน (เช่น 50/100/1)" style="flex:1;min-width:160px">
      </div>
      <div class="row">
        <input id="quickAmts" placeholder="Quick amounts คั่นด้วย , เช่น 50,100,150" style="flex:1">
        <button id="addFood" class="primary">เพิ่มเมนู</button>
      </div>
      <p class="muted" style="margin-top:6px">
        สูตรคำนวณ: <code>kcal = (จำนวนที่กิน / หน่วยฐาน) × kcalต่อหน่วยฐาน</code>
      </p>
    </section>

    <!-- รายการโปรด: Dropdown + Quick + ลบ -->
    <section class="card">
      <h3 style="margin:0 0 8px">รายการโปรด (เลือกจาก Dropdown แล้วกดจำนวน)</h3>
      <div class="row">
        <select id="favSelect" style="flex:2"></select>
        <button id="deleteFav" class="danger">ลบเมนูนี้</button>
      </div>
      <div class="row" id="favQuickRow" style="margin-top:8px"></div>
    </section>

    <!-- บันทึกแบบกรอกเอง -->
    <section class="card">
      <h3 style="margin:0 0 8px">บันทึกแบบกรอกเอง (Manual)</h3>
      <div class="row">
        <input id="manualName" list="nameSuggestions" placeholder="ชื่อเมนู เช่น อกไก่, ไก่ปั่น" style="flex:2">
        <datalist id="nameSuggestions"></datalist>
        <input id="manualKcal" type="number" inputmode="decimal" placeholder="kcal ทั้งเมนู" style="flex:1;min-width:140px">
        <button id="addManual" class="primary">บันทึก</button>
      </div>
      <p class="muted" style="margin-top:6px">เหมาะกับเมนูที่ไม่ได้อยู่ในรายการโปรด พิมพ์ชื่อ + ใส่ kcal แล้วกดบันทึก</p>
    </section>

    <!-- ตารางวันนี้ -->
    <section class="card">
      <h3 style="margin:0 0 8px">บันทึกวันนี้</h3>
      <table>
        <thead><tr><th>เวลา</th><th>เมนู</th><th>จำนวน</th><th>kcal</th><th></th></tr></thead>
        <tbody id="entriesTbody"></tbody>
        <tfoot><tr><th colspan="3">รวมวันนี้</th><th id="sumToday">0</th><th></th></tr></tfoot>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="clearToday" class="ghost">ลบรายการ “วันนี้”</button>
      </div>
    </section>

    <!-- กราฟ -->
    <section class="card">
      <h3 style="margin:0 0 8px">กราฟแคลอรี่รายวัน (ย้อนหลัง 30 วัน)</h3>
      <div class="row" style="margin-bottom:6px">
        <span class="muted">แตะ/กรอกเพื่อจด → กราฟอัปเดตทันที</span>
        <div class="space"></div>
        <button id="btnPrev" class="ghost">ย้อนอีก 30 วัน</button>
        <button id="btnNow" class="ghost">กลับมาวันนี้</button>
      </div>
      <div id="chartWrap">
        <canvas id="dailyChart" height="220" aria-label="กราฟแคลอรี่ต่อวัน"></canvas>
      </div>
    </section>
  </main>

  <div class="fab">
    <span class="chip">เมนูโปรด ➜ เลือกดรอปดาวน์ / Manual ➜ พิมพ์ชื่อ+kcal</span>
  </div>

<script defer>
  // ─── คีย์เก็บข้อมูลในเครื่อง ─────────────────────────────
  const LS = { foods:'ctm_foods', entries:'ctm_entries', settings:'ctm_settings', names:'ctm_manual_names' };

  // ─── Utils ───────────────────────────────────────────────────
  const $ = s => document.querySelector(s);
  const toISO = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const todayISO = toISO(new Date());
  $('#todayStr').textContent = todayISO;

  const load = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? f; }catch{ return f; } }
  const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  // ─── ข้อมูลหลัก ─────────────────────────────────────────────
  const FOODS_URL = './foods.json'; // ถ้าเก็บใน data/ ให้เปลี่ยนเป็น './data/foods.json'
  let foods = load(LS.foods, null);     // ถ้าเคยมีในเครื่อง ใช้ของเดิมก่อน
  let entries = load(LS.entries, []);
  let settings = load(LS.settings, { daily_goal_kcal: 1800 });
  let manualNames = load(LS.names, []); // เก็บชื่อที่คุณเคยกรอกเอง (สำหรับ suggestion)

  async function fetchFoodsFromJson() {
    try {
      const res = await fetch(FOODS_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('fetch failed');
      return await res.json();
    } catch (e) {
      console.warn('โหลด foods.json ไม่ได้:', e);
      return null;
    }
  }

  // ─── Suggestions (รวมจาก foods + manualNames) ──────────────
  function renderNameSuggestions(){
    const dl = document.getElementById('nameSuggestions');
    if (!dl) return;
    dl.innerHTML = '';
    const uniq = new Set([
      ...foods.map(f => f.name).filter(Boolean),
      ...manualNames
    ]);
    [...uniq].sort((a,b)=>a.localeCompare(b,'th')).forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n;
      dl.appendChild(opt);
    });
  }

  // ─── Favorites dropdown + quick + delete ────────────────────
  function renderFavDropdown(){
    const sel = $('#favSelect'); sel.innerHTML = '';
    foods.forEach(f=>{
      const opt = document.createElement('option'); opt.value=f.id; opt.textContent=f.name; sel.appendChild(opt);
    });
    updateFavQuickRow();
  }
  function selectedFood(){
    const id = $('#favSelect').value;
    return foods.find(f=>f.id===id);
  }
  function updateFavQuickRow(){
    const row = $('#favQuickRow'); row.innerHTML = '';
    const f = selectedFood(); if(!f) return;
    (f.quick_amounts||[]).forEach(q=>{
      const btn = document.createElement('button');
      btn.textContent = `${q}${f.unit==='g'?'g':''}`;
      btn.onclick = ()=> addEntryByFood(f.id, q);
      row.appendChild(btn);
    });
  }
  $('#favSelect').onchange = updateFavQuickRow;
  $('#deleteFav').onclick = ()=>{
    const f = selectedFood(); if(!f) return;
    if(confirm(`ลบ "${f.name}" ออกจากรายการโปรด?`)){
      foods = foods.filter(x=>x.id!==f.id);
      save(LS.foods, foods);
      renderFavDropdown();
      renderNameSuggestions(); // อัปเดตคำแนะนำหลังลบ
    }
  };

  // ─── เพิ่มเมนูโปรด ─────────────────────────────────────────
  function addFood(){
    const name = $('#foodName').value.trim();
    const unit = $('#unit').value;
    const kcal_per_unit = Number($('#kcalPerUnit').value);
    const base_amount = Number($('#baseAmount').value);
    const quickAmts = $('#quickAmts').value.trim().split(',')
      .map(s=>Number(s.trim())).filter(n=>!isNaN(n)&&n>0);
    if(!name || !kcal_per_unit || !base_amount){ alert('กรอกชื่ออาหาร, kcal ต่อหน่วยฐาน, หน่วยฐาน ให้ครบ'); return; }
    const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Math.random().toString(36).slice(2,6);
    foods.push({id,name,unit,kcal_per_unit,base_amount,quick_amounts:quickAmts});
    save(LS.foods, foods);
    $('#foodName').value=''; $('#kcalPerUnit').value=''; $('#baseAmount').value=''; $('#quickAmts').value='';
    renderFavDropdown();
    renderNameSuggestions(); // อัปเดตคำแนะนำหลังเพิ่ม
  }
  $('#addFood').onclick = addFood;

  // ─── บันทึกแบบกรอกเอง ─────────────────────────────────────
  function addManual(){
    const name = $('#manualName').value.trim();
    const kcal = Number($('#manualKcal').value);
    if(!name || !kcal || kcal<=0){ alert('กรอกชื่อเมนูและ kcal ให้ถูกต้อง'); return; }
    if(!manualNames.includes(name)){
      manualNames.push(name);
      save(LS.names, manualNames);
      renderNameSuggestions(); // อัปเดตคำแนะนำเมื่อมีชื่อใหม่
    }
    const entry = { _id: crypto.randomUUID(), date: todayISO, created_at:new Date().toISOString(),
      manual_name: name, amount: '', kcal: Math.round(kcal) };
    entries.push(entry); save(LS.entries, entries);
    $('#manualName').value=''; $('#manualKcal').value='';
    renderEntries(); updateChart();
  }
  $('#addManual').onclick = addManual;

  // ─── ตารางวันนี้ + สรุป ────────────────────────────────────
  const kcalOf = (food, amount)=> (amount / food.base_amount) * food.kcal_per_unit;
  const sumDayKcal  = iso => entries.filter(e=>e.date===iso).reduce((a,e)=>a+e.kcal,0);
  const sumTodayKcal= ()=> sumDayKcal(todayISO);

  function renderEntries(){
    const tb = $('#entriesTbody'); tb.innerHTML = '';
    entries.filter(e=>e.date===todayISO).sort((a,b)=>a.created_at.localeCompare(b.created_at)).forEach(e=>{
      let name = e.manual_name || '';
      let unitTxt = '';
      if(e.food_id){
        const f = foods.find(x=>x.id===e.food_id);
        name = f?f.name:'(เมนูถูกลบ)';
        unitTxt = f?(f.unit==='g'?'g':'เสิร์ฟ'):'';
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(e.created_at).toLocaleTimeString()}</td>
        <td>${name}</td>
        <td>${e.amount? e.amount + ' ' + unitTxt : '-'}</td>
        <td>${e.kcal.toFixed(0)}</td>
        <td><button class="ghost" data-id="${e._id}">ลบ</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-id]').forEach(b=>{
      b.onclick = ()=>{
        entries = entries.filter(x=>x._id !== b.dataset.id);
        save(LS.entries, entries); renderEntries(); updateTodaySummary(); updateChart();
      };
    });
    updateTodaySummary();
  }
  function updateTodaySummary(){
    const sum = sumTodayKcal();
    const goal = Number(settings.daily_goal_kcal||0);
    let text = `วันนี้รวม ${sum.toFixed(0)} kcal`;
    if(goal>0){
      const remain = goal - sum;
      text += ` • เป้า ${goal} • เหลือ ${Math.max(remain,0).toFixed(0)} kcal`;
    }
    $('#todaySummary').textContent = text;
    $('#sumToday').textContent = sum.toFixed(0);
  }
  function addEntryByFood(food_id, amount){
    const f = foods.find(x=>x.id===food_id); if(!f) return;
    const entry = { _id: crypto.randomUUID(), date: todayISO, created_at:new Date().toISOString(),
      food_id, amount, kcal: Math.round(kcalOf(f, amount)) };
    entries.push(entry); save(LS.entries, entries);
    renderEntries(); updateChart();
  }
  $('#clearToday').onclick = ()=>{
    if(confirm('ลบรายการของวันนี้ทั้งหมด?')){
      entries = entries.filter(e=>e.date!==todayISO); save(LS.entries, entries);
      renderEntries(); updateChart();
    }
  };

  // ─── กราฟ 30 วัน ───────────────────────────────────────────
  let chart, startOffset = 0;
  const makeRange = (offset30=0)=>{
    const days=30, labels=[], data=[], goalLine=[];
    const goal = Number(settings.daily_goal_kcal||0);
    const end = new Date(); end.setDate(end.getDate()-offset30*days);
    const start = new Date(end); start.setDate(start.getDate()-(days-1));
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const iso=toISO(d); labels.push(iso); data.push(Math.round(sumDayKcal(iso))); goalLine.push(goal||null);
    }
    return {labels,data,goalLine};
  };
  function buildChart(){
    const ctx = document.getElementById('dailyChart');
    const {labels,data,goalLine} = makeRange(startOffset);
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[
        { label:'kcal/วัน', data, tension:0.25, pointRadius:3 },
        { label:'เป้าหมาย', data:goalLine, borderDash:[6,6], pointRadius:0 }
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:true}, tooltip:{callbacks:{label:(c)=>`${c.dataset.label}: ${c.parsed.y??0} kcal`}} },
        scales:{ x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:8}}, y:{beginAtZero:true,ticks:{stepSize:200}} }
      }
    });
  }
  function updateChart(){
    if(!window.Chart){ return; }
    if(!chart){ buildChart(); return; }
    const {labels,data,goalLine} = makeRange(startOffset);
    chart.data.labels=labels; chart.data.datasets[0].data=data; chart.data.datasets[1].data=goalLine; chart.update();
  }
  $('#btnPrev').onclick = ()=>{ startOffset+=1; updateChart(); };
  $('#btnNow').onclick  = ()=>{ startOffset=0;  updateChart(); };

  // ─── เริ่มต้นแอป (โหลด foods.json ถ้าจำเป็น) ───────────────
  async function initApp(){
    if(!foods){
      const fromJson = await fetchFoodsFromJson();
      if(fromJson && Array.isArray(fromJson) && fromJson.length){
        foods = fromJson; save(LS.foods, foods);
      }else{
        // fallback กันพัง
        foods = [
          { id:'chicken_shake', name:'อกไก่ปั่น', unit:'serving', kcal_per_unit:300, base_amount:1,   quick_amounts:[1] },
          { id:'natto',         name:'นัตโตะ',    unit:'g',       kcal_per_unit:100, base_amount:50,  quick_amounts:[50,100,150] },
          { id:'sweet_potato',  name:'มันหวาน',   unit:'g',       kcal_per_unit:90,  base_amount:100, quick_amounts:[100,200,300] }
        ];
        save(LS.foods, foods);
      }
    }

    renderFavDropdown();
    renderNameSuggestions();   // ← สำคัญ: เติม datalist จาก foods.json
    renderEntries(); renderGoal();

    if(window.Chart){ buildChart(); } else { window.addEventListener('load', ()=>{ if(window.Chart) buildChart(); }); }

    // PWA: Service Worker & Install
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
    let deferredPrompt=null; const btnInstall=document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.classList.remove('hide'); });
    btnInstall.onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; deferredPrompt=null; if(outcome!=='dismissed'){ btnInstall.classList.add('hide'); } };
  }

  initApp();
</script>
</body>
</html>
